---
name: CHIT Contract Check

# yamllint disable rule:truthy
on:
  push:
    branches:
      - main
    paths:
      - 'pmoves/supabase/**/*.sql'
      - 'pmoves/supabase/initdb/**'
      - 'pmoves/services/**'
      - 'pmoves/docs/SUPABASE_*.md'
      - '.github/workflows/chit-contract.yml'
  pull_request:
    paths:
      - 'pmoves/supabase/**/*.sql'
      - 'pmoves/supabase/initdb/**'
      - 'pmoves/services/**'
      - 'pmoves/docs/SUPABASE_*.md'
      - '.github/workflows/chit-contract.yml'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            pmoves
            docs
            .github/workflows
          sparse-checkout-cone-mode: false

      # Install ripgrep
      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: CHIT schema/endpoints checks
        shell: bash
        run: |
          set -euo pipefail
          # CHIT table DDL only exists when migrations/sql/db are present (not all branches contain them)
          table_paths=()
          for p in migrations sql db; do
            [[ -d "$p" ]] && table_paths+=("$p")
          done
          if (( ${#table_paths[@]} )); then
            rg -n "create table .*(anchors|constellations|shape_points|shape_index)" "${table_paths[@]}" || (echo "Missing CHIT tables" && exit 1)
          else
            echo "CHIT table check skipped (no migrations/sql/db present)"
          fi
          rg -n "POST /geometry/event|GET /shape/point/.*/jump|/geometry/decode/(text|image|audio)|/geometry/calibration/report" pmoves/services/ pmoves/gateway/ pmoves/api/ || (echo "Missing CHIT endpoints" && exit 1)
          rg -n "geometry.cgp.v1" -S || (echo "Missing event publish 'geometry.cgp.v1'" && exit 1)
          rg -n "CHIT_REQUIRE_SIGNATURE|CHIT_PASSPHRASE|CHIT_DECRYPT_ANCHORS|CHIT_CODEBOOK_PATH|CHIT_T5_MODEL" -S || (echo "Missing CHIT security/env flags" && exit 1)
          PATTERN_TABLES_BASE='create table .*('
          PATTERN_TABLES_SUFFIX='anchors|constellations|shape_points|shape_index)'
          PATTERN_TABLES="${PATTERN_TABLES_BASE}${PATTERN_TABLES_SUFFIX}"
          if ! rg -ni --iglob '*.sql' "$PATTERN_TABLES"; then
            echo "Missing CHIT tables"
            exit 1
          fi
          if ! rg -n 'POST /geometry/event' pmoves/services; then
            echo "Missing CHIT endpoint POST /geometry/event"
            exit 1
          fi
          if ! rg -n 'GET /shape/point/.*/jump' pmoves/services; then
            echo "Missing CHIT endpoint GET /shape/point/.*/jump"
            exit 1
          fi
          if ! rg -n '/geometry/decode/(text|image|audio)' pmoves/services; then
            echo "Missing CHIT endpoint /geometry/decode/*"
            exit 1
          fi
          if ! rg -n '/geometry/calibration/report' pmoves/services; then
            echo "Missing CHIT endpoint /geometry/calibration/report"
            exit 1
          fi
          if ! rg -n 'geometry.cgp.v1' -S; then
            echo "Missing event publish geometry.cgp.v1"
            exit 1
          fi
          if ! rg -n 'CHIT_REQUIRE_SIGNATURE' -S; then
            echo "Missing CHIT_REQUIRE_SIGNATURE flag"
            exit 1
          fi
          if ! rg -n 'CHIT_PASSPHRASE' -S; then
            echo "Missing CHIT_PASSPHRASE flag"
            exit 1
          fi
          if ! rg -n 'CHIT_DECRYPT_ANCHORS' -S; then
            echo "Missing CHIT_DECRYPT_ANCHORS flag"
            exit 1
          fi
          if ! rg -n 'CHIT_CODEBOOK_PATH' -S; then
            echo "Missing CHIT_CODEBOOK_PATH flag"
            exit 1
          fi
          if ! rg -n 'CHIT_T5_MODEL' -S; then
            echo "Missing CHIT_T5_MODEL flag"
            exit 1
          fi
