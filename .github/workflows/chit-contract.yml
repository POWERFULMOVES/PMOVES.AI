name: CHIT Contract Check
on: [push, pull_request]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install ripgrep
      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: CHIT schema/endpoints checks
        shell: bash
        run: |
          set -euo pipefail
          # CHIT table DDL only exists when migrations/sql/db are present (not all branches contain them)
          table_paths=()
          for p in migrations sql db; do
            [[ -d "$p" ]] && table_paths+=("$p")
          done
          if (( ${#table_paths[@]} )); then
            rg -n "create table .*(anchors|constellations|shape_points|shape_index)" "${table_paths[@]}" || (echo "Missing CHIT tables" && exit 1)
          else
            echo "CHIT table check skipped (no migrations/sql/db present)"
          fi
          rg -n "POST /geometry/event|GET /shape/point/.*/jump|/geometry/decode/(text|image|audio)|/geometry/calibration/report" services/ gateway/ api/ || (echo "Missing CHIT endpoints" && exit 1)
          rg -n "geometry.cgp.v1" -S || (echo "Missing event publish 'geometry.cgp.v1'" && exit 1)
          rg -n "CHIT_REQUIRE_SIGNATURE|CHIT_PASSPHRASE|CHIT_DECRYPT_ANCHORS|CHIT_CODEBOOK_PATH|CHIT_T5_MODEL" -S || (echo "Missing CHIT security/env flags" && exit 1)
