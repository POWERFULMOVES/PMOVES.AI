---
name: CHIT Contract Check

# yamllint disable rule:truthy
on:
  push:
    branches:
      - main
    paths:
      - 'pmoves/supabase/**/*.sql'
      - 'pmoves/supabase/initdb/**'
      - 'pmoves/services/**'
      - 'pmoves/docs/SUPABASE_*.md'
      - '.github/workflows/chit-contract.yml'
  pull_request:
    paths:
      - 'pmoves/supabase/**/*.sql'
      - 'pmoves/supabase/initdb/**'
      - 'pmoves/services/**'
      - 'pmoves/docs/SUPABASE_*.md'
      - '.github/workflows/chit-contract.yml'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            pmoves
            docs
            .github/workflows
          sparse-checkout-cone-mode: false

      # Install ripgrep
      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: CHIT schema/endpoints checks
        shell: bash
        run: |
          set -euo pipefail
          PATTERN_TABLES_BASE='create table .*('
          PATTERN_TABLES_SUFFIX='anchors|constellations|shape_points|shape_index)'
          PATTERN_TABLES="${PATTERN_TABLES_BASE}${PATTERN_TABLES_SUFFIX}"
          if ! rg -ni --iglob '*.sql' "$PATTERN_TABLES"; then
            echo "Missing CHIT tables"
            exit 1
          fi
          if ! rg -n 'POST /geometry/event' pmoves/services; then
            echo "Missing CHIT endpoint POST /geometry/event"
            exit 1
          fi
          if ! rg -n 'GET /shape/point/.*/jump' pmoves/services; then
            echo "Missing CHIT endpoint GET /shape/point/.*/jump"
            exit 1
          fi
          if ! rg -n '/geometry/decode/(text|image|audio)' pmoves/services; then
            echo "Missing CHIT endpoint /geometry/decode/*"
            exit 1
          fi
          if ! rg -n '/geometry/calibration/report' pmoves/services; then
            echo "Missing CHIT endpoint /geometry/calibration/report"
            exit 1
          fi
          if ! rg -n 'geometry.cgp.v1' -S; then
            echo "Missing event publish geometry.cgp.v1"
            exit 1
          fi
          if ! rg -n 'CHIT_REQUIRE_SIGNATURE' -S; then
            echo "Missing CHIT_REQUIRE_SIGNATURE flag"
            exit 1
          fi
          if ! rg -n 'CHIT_PASSPHRASE' -S; then
            echo "Missing CHIT_PASSPHRASE flag"
            exit 1
          fi
          if ! rg -n 'CHIT_DECRYPT_ANCHORS' -S; then
            echo "Missing CHIT_DECRYPT_ANCHORS flag"
            exit 1
          fi
          if ! rg -n 'CHIT_CODEBOOK_PATH' -S; then
            echo "Missing CHIT_CODEBOOK_PATH flag"
            exit 1
          fi
          if ! rg -n 'CHIT_T5_MODEL' -S; then
            echo "Missing CHIT_T5_MODEL flag"
            exit 1
          fi
