services:
  hi-rag-gateway-v2-gpu:
    image: ${HIRAG_V2_GPU_IMAGE:-ghcr.io/cataclysm-studios-inc/hi-rag-gateway-v2-gpu:cu128-py310-stable}
    runtime: nvidia
    restart: unless-stopped
    env_file: [env.shared.generated, env.shared, .env.generated, .env.local]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pmoves_chunks}
      - SENTENCE_MODEL=${SENTENCE_MODEL:-all-MiniLM-L6-v2}
      - INDEXER_NAMESPACE=${INDEXER_NAMESPACE:-pmoves}
      - RERANK_ENABLE=${RERANK_ENABLE:-true}
      - RERANK_MODEL=${RERANK_MODEL:-Qwen/Qwen3-Reranker-4B}
      - RERANK_TOPN=${RERANK_TOPN:-50}
      - RERANK_K=${RERANK_K:-10}
      - RERANK_FUSION=${RERANK_FUSION:-mul}
      - USE_MEILI=${USE_MEILI:-true}
      - MEILI_URL=${MEILI_URL:-http://meilisearch:7700}
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - GRAPH_BOOST=${GRAPH_BOOST:-0.15}
      - ENTITY_CACHE_TTL=${ENTITY_CACHE_TTL:-60}
      - ENTITY_CACHE_MAX=${ENTITY_CACHE_MAX:-1000}
      - NEO4J_URL=${NEO4J_URL}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - SUPA_REST_URL=${SUPA_REST_URL:-http://host.docker.internal:65421/rest/v1}
      - SUPABASE_REALTIME_URL=${SUPABASE_REALTIME_URL:-ws://host.docker.internal:65421/realtime/v1}
      - OLLAMA_URL=${OLLAMA_URL:-http://pmoves-ollama:11434}
      - OLLAMA_EMBED_MODEL=${OLLAMA_EMBED_MODEL:-embeddinggemma:300m}
      - TENSORZERO_BASE_URL=${TENSORZERO_BASE_URL:-http://tensorzero-gateway:3000}
      - TENSORZERO_API_KEY=${TENSORZERO_API_KEY:-}
      - TENSORZERO_EMBED_MODEL=${TENSORZERO_EMBED_MODEL:-tensorzero::embedding_model_name::gemma_embed_local}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}
    gpus: all
    ports: ["${HIRAG_V2_GPU_HOST_PORT:-8087}:8086"]
    profiles: ["gpu"]
    depends_on:
      qdrant:
        condition: service_started
        required: false
      neo4j:
        condition: service_healthy
        required: false
    networks: [pmoves]
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  pmoves:
    external: true
    name: pmoves-net

