services:
  postgres:
    image: ankane/pgvector
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-pmoves}
      - POSTGRES_USER=${POSTGRES_USER:-pmoves}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-pmoves}
    ports: ["5432:5432"]
    volumes:
      - supabase-data:/var/lib/postgresql/data
      - ./supabase/initdb:/docker-entrypoint-initdb.d:ro
    profiles: ["data","orchestration","supabase-local"]
    networks: [pmoves]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgrest:
    image: postgrest/postgrest:latest
    restart: unless-stopped
    depends_on: [postgres]
    environment:
      - PGRST_DB_URI=postgres://${POSTGRES_USER:-pmoves}:${POSTGRES_PASSWORD:-pmoves}@postgres:5432/${POSTGRES_DB:-pmoves}
      - PGRST_DB_SCHEMA=${PGRST_DB_SCHEMA:-public,pmoves_core}
      - PGRST_DB_ANON_ROLE=${PGRST_DB_ANON_ROLE:-anon}
      - PGRST_SERVER_PORT=3000
    ports: ["3000:3000"]
    profiles: ["orchestration","workers","supabase-local"]
    networks: [pmoves]
  qdrant:
    image: qdrant/qdrant:v1.10.0
    restart: unless-stopped
    ports: ["6333:6333"]
    profiles: ["data","qdrant-local"]
    networks: [pmoves]
  meilisearch:
    image: getmeili/meilisearch:v1.8
    restart: unless-stopped
    environment:
      - MEILI_ENV=production
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-master_key}
    ports: ["7700:7700"]
    profiles: ["data","meili-local"]
    networks: [pmoves]
  neo4j:
    image: neo4j:5.22
    restart: unless-stopped
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
    ports: ["7474:7474","7687:7687"]
    volumes:
      - neo4j-data:/data
      - ./neo4j/cypher:/cypher:ro
    profiles: ["data","neo4j-local"]
    networks: [pmoves]
    healthcheck:
      test: ["CMD-SHELL", "auth=\"$$NEO4J_AUTH\"; user=\"$${auth%%/*}\"; pass=\"$${auth#*/}\"; /var/lib/neo4j/bin/cypher-shell -a bolt://localhost:7687 -u \"$$user\" -p \"$$pass\" 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports: ["9000:9000","9001:9001"]
    volumes:
      - minio-data:/data
    profiles: ["data"]
    networks: [pmoves]
  hi-rag-gateway:
    build: ./services/hi-rag-gateway
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION}
      - SENTENCE_MODEL=all-MiniLM-L6-v2
      - HIRAG_HTTP_PORT=${HIRAG_HTTP_PORT}
      - NEO4J_URL=${NEO4J_URL}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - GRAPH_BOOST=${GRAPH_BOOST}
      - ENTITY_CACHE_TTL=${ENTITY_CACHE_TTL}
      - ENTITY_CACHE_MAX=${ENTITY_CACHE_MAX}
      - USE_MEILI=${USE_MEILI}
      - MEILI_URL=http://meilisearch:7700
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - NEO4J_DICT_REFRESH_SEC=${NEO4J_DICT_REFRESH_SEC}
      - NEO4J_DICT_LIMIT=${NEO4J_DICT_LIMIT}
      - TAILSCALE_ONLY=${TAILSCALE_ONLY}
      - TAILSCALE_ADMIN_ONLY=${TAILSCALE_ADMIN_ONLY}
      - TAILSCALE_CIDRS=${TAILSCALE_CIDRS}
    ports: ["8086:8086"]
    profiles: ["legacy"]
    depends_on:
      qdrant:
        condition: service_started
      neo4j:
        condition: service_healthy
    networks: [pmoves]
  retrieval-eval:
    build: ./services/retrieval-eval
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - HIRAG_URL=http://hi-rag-gateway-v2:8086
      - EVAL_HTTP_PORT=${EVAL_HTTP_PORT}
    depends_on: [hi-rag-gateway-v2]
    ports: ["8090:8090"]
    volumes:
      - ./services/retrieval-eval:/app:rw
      - ./datasets:/app/data:rw
    profiles: ["workers"]
    networks: [pmoves]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  presign:
    build: ./services/presign
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=${MINIO_SECURE:-false}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
      - ALLOWED_BUCKETS=${ALLOWED_BUCKETS:-assets,outputs}
      - PRESIGN_SHARED_SECRET=${PRESIGN_SHARED_SECRET}
    ports: ["8088:8080"]
    profiles: ["data","orchestration"]
    networks: [pmoves]

  render-webhook:
    build: ./services/render-webhook
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - SUPA_REST_URL=${SUPA_REST_URL:-http://postgrest:3000}
      - DEFAULT_NAMESPACE=${INDEXER_NAMESPACE:-pmoves}
      - RENDER_WEBHOOK_SHARED_SECRET=${RENDER_WEBHOOK_SHARED_SECRET}
      - RENDER_AUTO_APPROVE=${RENDER_AUTO_APPROVE:-false}
    ports: ["8085:8085"]
    profiles: ["orchestration","workers"]
    networks: [pmoves]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  extract-worker:
    build: ./services/extract-worker
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pmoves_chunks}
      - SENTENCE_MODEL=${SENTENCE_MODEL:-all-MiniLM-L6-v2}
      - MEILI_URL=${MEILI_URL:-http://meilisearch:7700}
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - SUPA_REST_URL=${SUPA_REST_URL:-http://postgrest:3000}
    ports: ["8083:8083"]
    profiles: ["workers","orchestration"]
    networks: [pmoves]
    extra_hosts:
      - "host.docker.internal:host-gateway"
  pdf-ingest:
    build:
      context: .
      dockerfile: services/pdf-ingest/Dockerfile
    restart: unless-stopped
    env_file: [.env]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=${MINIO_SECURE:-false}
      - PDF_DEFAULT_BUCKET=${PDF_DEFAULT_BUCKET:-assets}
      - PDF_DEFAULT_NAMESPACE=${PDF_DEFAULT_NAMESPACE:-pmoves}
      - PDF_MAX_PAGES=${PDF_MAX_PAGES:-0}
      - PDF_INGEST_EXTRACT_URL=${PDF_INGEST_EXTRACT_URL:-http://extract-worker:8083/ingest}
      - NATS_URL=${NATS_URL:-nats://nats:4222}
    depends_on:
      extract-worker:
        condition: service_started
      minio:
        condition: service_started
    ports: ["8092:8092"]
    profiles: ["workers","orchestration"]
    networks: [pmoves]
  langextract:
    build:
      context: .
      dockerfile: services/langextract/Dockerfile
    restart: unless-stopped
    env_file: [.env, .env.local]
    ports: ["8084:8084"]
    profiles: ["workers","orchestration"]
    networks: [pmoves]

  ffmpeg-whisper:
    build: ./services/ffmpeg-whisper
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=${MINIO_SECURE:-false}
      - USE_CUDA=${USE_CUDA:-true}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              count: ${GPU_COUNT:-all}
    ports: ["8078:8078"]
    profiles: ["workers","orchestration","agents"]
    networks: [pmoves]

  media-video:
    build: ./services/media-video
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=${MINIO_SECURE:-false}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - YOLO_MODEL=${YOLO_MODEL:-yolov8n.pt}
      - FRAME_EVERY=${FRAME_EVERY:-5}
      - SCORE_THRES=${SCORE_THRES:-0.25}
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              count: ${GPU_COUNT:-all}
    ports: ["8079:8079"]
    profiles: ["workers","orchestration"]
    networks: [pmoves]

  media-audio:
    build: ./services/media-audio
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=${MINIO_SECURE:-false}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - EMOTION_MODEL=${EMOTION_MODEL:-superb/hubert-large-superb-er}
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              count: ${GPU_COUNT:-all}
    ports: ["8082:8082"]
    profiles: ["workers","orchestration"]
    networks: [pmoves]
  pmoves-yt:
    build: ./services/pmoves-yt
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=${MINIO_SECURE:-false}
      - YT_BUCKET=${YT_BUCKET:-assets}
      - INDEXER_NAMESPACE=${INDEXER_NAMESPACE:-pmoves}
      - SUPA_REST_URL=${SUPA_REST_URL:-http://postgrest:3000}
      - NATS_URL=${NATS_URL:-nats://nats:4222}
    depends_on: [minio]
    ports: ["8077:8077"]
    profiles: ["orchestration","workers","agents"]
    networks: [pmoves]

  # Optional: experimental v2 gateway with rerank providers
  hi-rag-gateway-v2:
    build:
      context: .
      dockerfile: services/hi-rag-gateway-v2/Dockerfile
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pmoves_chunks}
      - SENTENCE_MODEL=${SENTENCE_MODEL:-all-MiniLM-L6-v2}
      - INDEXER_NAMESPACE=${INDEXER_NAMESPACE:-pmoves}
      - ALPHA=${ALPHA:-0.7}
      - RERANK_ENABLE=${RERANK_ENABLE:-true}
      - RERANK_MODEL=${RERANK_MODEL:-BAAI/bge-reranker-base}
      - RERANK_TOPN=${RERANK_TOPN:-50}
      - RERANK_K=${RERANK_K:-10}
      - RERANK_FUSION=${RERANK_FUSION:-mul}
      - USE_MEILI=${USE_MEILI:-false}
      - MEILI_URL=${MEILI_URL:-http://meilisearch:7700}
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - USE_OLLAMA_EMBED=${USE_OLLAMA_EMBED:-false}
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      - GRAPH_BOOST=${GRAPH_BOOST:-0.15}
      - ENTITY_CACHE_TTL=${ENTITY_CACHE_TTL:-60}
      - ENTITY_CACHE_MAX=${ENTITY_CACHE_MAX:-1000}
      - NEO4J_URL=${NEO4J_URL}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DICT_REFRESH_SEC=${NEO4J_DICT_REFRESH_SEC:-60}
      - NEO4J_DICT_LIMIT=${NEO4J_DICT_LIMIT:-50000}
      - TAILSCALE_ONLY=${TAILSCALE_ONLY:-false}
      - TAILSCALE_CIDRS=${TAILSCALE_CIDRS:-100.64.0.0/10}
    ports: ["8087:8086"]
    profiles: ["workers","gateway"]
    depends_on:
      qdrant:
        condition: service_started
      neo4j:
        condition: service_healthy
    networks: [pmoves]

  # GPU-enabled variant of v2 gateway with CLAP/torch installed
  hi-rag-gateway-v2-gpu:
    build:
      context: .
      dockerfile: services/hi-rag-gateway-v2/Dockerfile.gpu
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pmoves_chunks}
      - SENTENCE_MODEL=${SENTENCE_MODEL:-all-MiniLM-L6-v2}
      - INDEXER_NAMESPACE=${INDEXER_NAMESPACE:-pmoves}
      - ALPHA=${ALPHA:-0.7}
      - USE_MEILI=${USE_MEILI:-false}
      - MEILI_URL=${MEILI_URL:-http://meilisearch:7700}
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - GRAPH_BOOST=${GRAPH_BOOST:-0.15}
      - ENTITY_CACHE_TTL=${ENTITY_CACHE_TTL:-60}
      - ENTITY_CACHE_MAX=${ENTITY_CACHE_MAX:-1000}
      - NEO4J_URL=${NEO4J_URL}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DICT_REFRESH_SEC=${NEO4J_DICT_REFRESH_SEC:-60}
      - NEO4J_DICT_LIMIT=${NEO4J_DICT_LIMIT:-50000}
      - CHIT_DECODE_TEXT=${CHIT_DECODE_TEXT:-true}
      - CHIT_DECODE_IMAGE=${CHIT_DECODE_IMAGE:-true}
      - CHIT_DECODE_AUDIO=${CHIT_DECODE_AUDIO:-true}
      - CHIT_PERSIST_DB=${CHIT_PERSIST_DB:-false}
      - PGHOST=${PGHOST:-postgres}
      - PGPORT=${PGPORT:-5432}
      - PGUSER=${POSTGRES_USER:-pmoves}
      - PGPASSWORD=${POSTGRES_PASSWORD:-pmoves}
      - PGDATABASE=${POSTGRES_DB:-pmoves}
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              count: ${GPU_COUNT:-all}
    ports: ["8087:8086"]
    profiles: ["gpu"]
    depends_on:
      qdrant:
        condition: service_started
      neo4j:
        condition: service_healthy
    networks: [pmoves]

  # Agents profile (opt-in): NATS broker + Agent Zero + Archon
  nats:
    image: nats:2.10-alpine
    restart: unless-stopped
    ports: ["4222:4222"]
    profiles: ["agents"]
    networks: [pmoves]

  agent-zero:
    build:
      context: .
      dockerfile: ./services/agent-zero/Dockerfile
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - PORT=8080
      - NATS_URL=${NATS_URL:-nats://nats:4222}
    depends_on: [nats]
    ports: ["8080:8080"]
    volumes:
      # Default host directories keep Agent Zero runtime data between restarts.
      # Override AGENT_ZERO_*_DIR env vars in your shell to point at different host paths.
      - ${AGENT_ZERO_MEMORY_DIR:-./data/agent-zero/memory}:/app/runtime/memory
      - ${AGENT_ZERO_KNOWLEDGE_DIR:-./data/agent-zero/knowledge}:/app/runtime/knowledge
      - ${AGENT_ZERO_INSTRUMENTS_DIR:-./data/agent-zero/instruments}:/app/runtime/instruments
      - ${AGENT_ZERO_LOG_DIR:-./data/agent-zero/logs}:/app/logs
    profiles: ["agents"]
    networks: [pmoves]

  archon:
    build:
      context: .
      dockerfile: ./services/archon/Dockerfile
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - PORT=8091
      - NATS_URL=${NATS_URL:-nats://nats:4222}
    depends_on: [nats]
    ports: ["8091:8091"]
    profiles: ["agents"]
    networks: [pmoves]

  mesh-agent:
    build: ./services/mesh-agent
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - NATS_URL=${NATS_URL:-nats://nats:4222}
      - HIRAG_URL=${HIRAG_URL:-http://hi-rag-gateway-v2-gpu:8086}
      - ANNOUNCE_SEC=${ANNOUNCE_SEC:-15}
    depends_on: [nats]
    profiles: ["agents"]
    networks: [pmoves]

  publisher-discord:
    build: ./services/publisher-discord
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - NATS_URL=${NATS_URL:-nats://nats:4222}
      - DISCORD_SUBJECTS=${DISCORD_SUBJECTS:-ingest.file.added.v1,ingest.transcript.ready.v1,ingest.summary.ready.v1,ingest.chapters.ready.v1}
    depends_on: [nats]
    ports: ["8094:8092"]
    profiles: ["orchestration","agents"]
    networks: [pmoves]

  jellyfin-bridge:
    build: ./services/jellyfin-bridge
    restart: unless-stopped
    env_file: [.env, .env.local]
    environment:
      - JELLYFIN_URL=${JELLYFIN_URL}
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY}
      - JELLYFIN_USER_ID=${JELLYFIN_USER_ID}
      - SUPA_REST_URL=${SUPA_REST_URL:-http://postgrest:3000}
    ports: ["8093:8093"]
    profiles: ["orchestration"]
    networks: [pmoves]
volumes:
  neo4j-data: {}
  minio-data: {}
  supabase-data: {}
networks:
  pmoves:
    name: pmoves-net
