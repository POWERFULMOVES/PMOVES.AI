services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-pmoves}
      - POSTGRES_USER=${POSTGRES_USER:-pmoves}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-pmoves}
    ports: ["5432:5432"]
    volumes:
      - supabase-data:/var/lib/postgresql/data
      - ./supabase/initdb:/docker-entrypoint-initdb.d:ro
    profiles: ["data","orchestration"]
    networks: [pmoves]

  postgrest:
    image: postgrest/postgrest:latest
    restart: unless-stopped
    depends_on: [postgres]
    environment:
      - PGRST_DB_URI=postgres://${POSTGRES_USER:-pmoves}:${POSTGRES_PASSWORD:-pmoves}@postgres:5432/${POSTGRES_DB:-pmoves}
      - PGRST_DB_SCHEMA=${PGRST_DB_SCHEMA:-public,pmoves_core}
      - PGRST_DB_ANON_ROLE=${PGRST_DB_ANON_ROLE:-anon}
      - PGRST_SERVER_PORT=3000
    ports: ["3000:3000"]
    profiles: ["orchestration","workers"]
    networks: [pmoves]
  qdrant:
    image: qdrant/qdrant:v1.10.0
    restart: unless-stopped
    ports: ["6333:6333"]
    profiles: ["data"]
    networks: [pmoves]
  meilisearch:
    image: getmeili/meilisearch:v1.8
    restart: unless-stopped
    environment:
      - MEILI_ENV=production
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-master_key}
    ports: ["7700:7700"]
    profiles: ["data"]
    networks: [pmoves]
  neo4j:
    image: neo4j:5.22
    restart: unless-stopped
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
    ports: ["7474:7474","7687:7687"]
    volumes:
      - neo4j-data:/data
      - ./neo4j/cypher:/cypher:ro
    profiles: ["data"]
    networks: [pmoves]
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports: ["9000:9000","9001:9001"]
    volumes:
      - minio-data:/data
    profiles: ["data"]
    networks: [pmoves]
  hi-rag-gateway:
    build: ./services/hi-rag-gateway
    restart: unless-stopped
    env_file: [.env]
    environment:
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION}
      - SENTENCE_MODEL=all-MiniLM-L6-v2
      - HIRAG_HTTP_PORT=${HIRAG_HTTP_PORT}
      - NEO4J_URL=${NEO4J_URL}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - GRAPH_BOOST=${GRAPH_BOOST}
      - ENTITY_CACHE_TTL=${ENTITY_CACHE_TTL}
      - ENTITY_CACHE_MAX=${ENTITY_CACHE_MAX}
      - USE_MEILI=${USE_MEILI}
      - MEILI_URL=http://meilisearch:7700
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - NEO4J_DICT_REFRESH_SEC=${NEO4J_DICT_REFRESH_SEC}
      - NEO4J_DICT_LIMIT=${NEO4J_DICT_LIMIT}
      - TAILSCALE_ONLY=${TAILSCALE_ONLY}
      - TAILSCALE_ADMIN_ONLY=${TAILSCALE_ADMIN_ONLY}
      - TAILSCALE_CIDRS=${TAILSCALE_CIDRS}
    ports: ["8086:8086"]
    profiles: ["legacy"]
    depends_on:
      - qdrant
      - neo4j
    networks: [pmoves]
  retrieval-eval:
    build: ./services/retrieval-eval
    restart: unless-stopped
    env_file: [.env]
    environment:
      - HIRAG_URL=http://hi-rag-gateway-v2:8086
      - EVAL_HTTP_PORT=${EVAL_HTTP_PORT}
    depends_on: [hi-rag-gateway-v2]
    ports: ["8090:8090"]
    volumes:
      - ./services/retrieval-eval:/app:rw
      - ./datasets:/app/data:rw
    profiles: ["workers"]
    networks: [pmoves]

  presign:
    build: ./services/presign
    restart: unless-stopped
    env_file: [.env]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_SECURE=${MINIO_SECURE:-false}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
      - ALLOWED_BUCKETS=${ALLOWED_BUCKETS:-assets,outputs}
      - PRESIGN_SHARED_SECRET=${PRESIGN_SHARED_SECRET}
    ports: ["8088:8080"]
    profiles: ["data","orchestration"]
    networks: [pmoves]

  render-webhook:
    build: ./services/render-webhook
    restart: unless-stopped
    env_file: [.env]
    environment:
      - SUPA_REST_URL=${SUPA_REST_URL:-http://postgrest:3000}
      - DEFAULT_NAMESPACE=${INDEXER_NAMESPACE:-pmoves}
      - RENDER_WEBHOOK_SHARED_SECRET=${RENDER_WEBHOOK_SHARED_SECRET}
      - RENDER_AUTO_APPROVE=${RENDER_AUTO_APPROVE:-false}
    ports: ["8085:8085"]
    profiles: ["orchestration","workers"]
    networks: [pmoves]

  extract-worker:
    build: ./services/extract-worker
    restart: unless-stopped
    env_file: [.env]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pmoves_chunks}
      - SENTENCE_MODEL=${SENTENCE_MODEL:-all-MiniLM-L6-v2}
      - MEILI_URL=${MEILI_URL:-http://meilisearch:7700}
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - SUPA_REST_URL=${SUPA_REST_URL:-http://postgrest:3000}
    ports: ["8083:8083"]
    profiles: ["workers","orchestration"]
    networks: [pmoves]
  langextract:
    build: ./services/langextract
    restart: unless-stopped
    env_file: [.env]
    ports: ["8084:8084"]
    profiles: ["workers","orchestration"]
    networks: [pmoves]

  # Optional: experimental v2 gateway with rerank providers
  hi-rag-gateway-v2:
    build: ./services/hi-rag-gateway-v2
    restart: unless-stopped
    env_file: [.env]
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pmoves_chunks}
      - SENTENCE_MODEL=${SENTENCE_MODEL:-all-MiniLM-L6-v2}
      - INDEXER_NAMESPACE=${INDEXER_NAMESPACE:-pmoves}
      - ALPHA=${ALPHA:-0.7}
      - RERANK_ENABLE=${RERANK_ENABLE:-true}
      - RERANK_MODEL=${RERANK_MODEL:-BAAI/bge-reranker-base}
      - RERANK_TOPN=${RERANK_TOPN:-50}
      - RERANK_K=${RERANK_K:-10}
      - RERANK_FUSION=${RERANK_FUSION:-mul}
      - USE_MEILI=${USE_MEILI:-false}
      - MEILI_URL=${MEILI_URL:-http://meilisearch:7700}
      - MEILI_API_KEY=${MEILI_MASTER_KEY}
      - USE_OLLAMA_EMBED=${USE_OLLAMA_EMBED:-false}
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      - GRAPH_BOOST=${GRAPH_BOOST:-0.15}
      - ENTITY_CACHE_TTL=${ENTITY_CACHE_TTL:-60}
      - ENTITY_CACHE_MAX=${ENTITY_CACHE_MAX:-1000}
      - NEO4J_URL=${NEO4J_URL}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DICT_REFRESH_SEC=${NEO4J_DICT_REFRESH_SEC:-60}
      - NEO4J_DICT_LIMIT=${NEO4J_DICT_LIMIT:-50000}
      - TAILSCALE_ONLY=${TAILSCALE_ONLY:-false}
      - TAILSCALE_CIDRS=${TAILSCALE_CIDRS:-100.64.0.0/10}
    ports: ["8087:8086"]
    profiles: ["workers"]
    networks: [pmoves]
volumes:
  neo4j-data: {}
  minio-data: {}
  supabase-data: {}
networks:
  pmoves:
    name: pmoves-net
