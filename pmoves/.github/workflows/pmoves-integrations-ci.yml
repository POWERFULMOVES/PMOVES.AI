name: PMOVES Integrations CI

on:
  pull_request:
    paths:
      - 'pmoves/compose/docker-compose.wger.yml'
      - 'pmoves/compose/docker-compose.firefly.yml'
      - 'pmoves/compose/docker-compose.flows-watcher.yml'
      - 'pmoves/scripts/n8n-import-flows.sh'
      - 'pmoves/scripts/n8n-flows-watcher.sh'
      - 'pmoves/integrations/**'
      - 'pmoves/.github/workflows/pmoves-integrations-ci.yml'
  workflow_dispatch: {}

jobs:
  matrix-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: wger
            extra_files: "-f compose/docker-compose.wger.yml"
            profiles: "--profile wger"
            check_wger: true
            check_firefly: false
          - name: firefly
            extra_files: "-f compose/docker-compose.firefly.yml"
            profiles: "--profile firefly"
            check_wger: false
            check_firefly: true
          - name: pbj
            extra_files: "-f compose/docker-compose.wger.yml -f compose/docker-compose.firefly.yml -f compose/docker-compose.flows-watcher.yml"
            profiles: "--profile wger --profile firefly"
            check_wger: true
            check_firefly: true

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install workflow dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create .env for CI
        working-directory: pmoves
        run: |
          cat > .env <<'ENVEOF'
          N8N_BASIC_AUTH_USER=admin
          N8N_BASIC_AUTH_PASSWORD=adminpass
          N8N_ENCRYPTION_KEY=$(openssl rand -hex 32)

          SUPABASE_DB_PASSWORD=supabase

          WGER_DB_PASSWORD=wgerpass
          WGER_SECRET_KEY=$(openssl rand -hex 32)

          FIREFLY_DB_PASSWORD=fireflypass
          FIREFLY_APP_KEY=base64:$(openssl rand -base64 32 | tr -d '\n')
          TZ=UTC
          ENVEOF
          echo "Generated .env:"
          sed -e 's/=.*/=********/' .env

      - name: Compose up (${{ matrix.name }})
        working-directory: pmoves
        run: |
          docker compose -f compose/docker-compose.core.yml ${{ matrix.extra_files }} ${{ matrix.profiles }} up -d
          echo "Containers:"
          docker ps --format 'table {{.Names}}  {{.Status}}'

      - name: Wait for n8n to be healthy
        working-directory: pmoves
        run: |
          for i in $(seq 1 60); do
            if curl -fsS -u "admin:adminpass" http://localhost:5678/rest/healthz >/dev/null; then
              echo "n8n ready"; exit 0
            fi
            sleep 3
          done
          echo "n8n failed to become healthy" >&2
          docker compose logs n8n || true
          exit 1

      - name: Import n8n flows (health-wger)
        if: ${{ hashFiles('pmoves/integrations/health-wger/n8n/flows/*.json') != '' }}
        working-directory: pmoves
        run: |
          for f in integrations/health-wger/n8n/flows/*.json; do
            [ -e "$f" ] || continue
            NAME=$(jq -r '.name // .meta.name // "Unnamed Flow"' < "$f")
            EXISTING=$(curl -sS -u "admin:adminpass" http://localhost:5678/rest/workflows)
            ID=$(echo "$EXISTING" | jq -r --arg n "$NAME" '.data[] | select(.name==$n) | .id' | head -n1)
            if [ -n "$ID" ] && [ "$ID" != "null" ]; then
              curl -sS -u "admin:adminpass" -X PATCH http://localhost:5678/rest/workflows/$ID \
                -H 'Content-Type: application/json' --data-binary "@$f" >/dev/null
              echo "Updated workflow: $NAME ($ID)"
            else
              curl -sS -u "admin:adminpass" -X POST http://localhost:5678/rest/workflows \
                -H 'Content-Type: application/json' --data-binary "@$f" >/dev/null
              echo "Created workflow: $NAME"
            fi
          done

      - name: Import n8n flows (firefly-iii)
        if: ${{ hashFiles('pmoves/integrations/firefly-iii/n8n/flows/*.json') != '' }}
        working-directory: pmoves
        run: |
          for f in integrations/firefly-iii/n8n/flows/*.json; do
            [ -e "$f" ] || continue
            NAME=$(jq -r '.name // .meta.name // "Unnamed Flow"' < "$f")
            EXISTING=$(curl -sS -u "admin:adminpass" http://localhost:5678/rest/workflows)
            ID=$(echo "$EXISTING" | jq -r --arg n "$NAME" '.data[] | select(.name==$n) | .id' | head -n1)
            if [ -n "$ID" ] && [ "$ID" != "null" ]; then
              curl -sS -u "admin:adminpass" -X PATCH http://localhost:5678/rest/workflows/$ID \
                -H 'Content-Type: application/json' --data-binary "@$f" >/dev/null
              echo "Updated workflow: $NAME ($ID)"
            else
              curl -sS -u "admin:adminpass" -X POST http://localhost:5678/rest/workflows \
                -H 'Content-Type: application/json' --data-binary "@$f" >/dev/null
              echo "Created workflow: $NAME"
            fi
          done

      - name: Verify flows imported
        working-directory: pmoves
        run: |
          COUNT=$(curl -sS -u "admin:adminpass" http://localhost:5678/rest/workflows | jq '.data | length')
          echo "Workflows in n8n: $COUNT"
          test "$COUNT" -ge 0

      - name: Probe Wger
        if: ${{ matrix.check_wger }}
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:8000/ >/dev/null; then
              echo "Wger responsive"; exit 0
            fi
            sleep 3
          done
          echo "Wger not responding" >&2
          exit 1

      - name: Probe Firefly
        if: ${{ matrix.check_firefly }}
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:8080/ >/dev/null; then
              echo "Firefly responsive"; exit 0
            fi
            sleep 3
          done
          echo "Firefly not responding" >&2
          exit 1

      - name: Compose down
        if: always()
        working-directory: pmoves
        run: |
          docker compose -f compose/docker-compose.core.yml ${{ matrix.extra_files }} ${{ matrix.profiles }} down -v
