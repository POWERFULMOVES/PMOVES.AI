version: "3.9"

services:
  wger:
    image: ${WGER_IMAGE:-ghcr.io/cataclysm-studios-inc/pmoves-health-wger:pmoves-latest}
    container_name: cataclysm-wger
    restart: unless-stopped
    env_file: [env.shared.generated, env.shared, .env.generated, .env.local]
    networks:
      cataclysm:
        aliases:
          - cataclysm-wger
          - pmoves-wger
    environment:
      DJANGO_DEBUG: "${WGER_DJANGO_DEBUG:-False}"
      WGER_USE_GUNICORN: "${WGER_USE_GUNICORN:-True}"
      DJANGO_CLEAR_STATIC_FIRST: "${WGER_CLEAR_STATIC_FIRST:-True}"
      TIME_ZONE: "${WGER_TIME_ZONE:-America/New_York}"
      SITE_URL: "${WGER_SITE_URL:-http://localhost:8000}"
      FROM_EMAIL: "${WGER_FROM_EMAIL:-PMOVES Health Coach <ops@cataclysmstudios.com>}"
      DJANGO_ADMINS: "${WGER_DJANGO_ADMINS:-PMOVES Ops <ops@cataclysmstudios.com>}"
    volumes:
      - wger-static:/home/wger/static
      - wger-media:/home/wger/media

  wger-nginx:
    image: ${WGER_NGINX_IMAGE:-nginx:1.27-alpine}
    container_name: cataclysm-wger-nginx
    restart: unless-stopped
    depends_on:
      - wger
    networks:
      cataclysm:
        aliases:
          - cataclysm-wger-nginx
    ports:
      - "${WGER_HOST_PORT:-8000}:80"
    volumes:
      - wger-static:/wger/static:ro
      - wger-media:/wger/media:ro
      - ./integrations/pr-kits/wger/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  firefly:
    image: ${FIREFLY_IMAGE:-ghcr.io/cataclysm-studios-inc/pmoves-firefly-iii:pmoves-latest}
    container_name: cataclysm-firefly
    restart: unless-stopped
    env_file: [env.shared.generated, env.shared, .env.generated, .env.local]
    networks:
      cataclysm:
        aliases:
          - cataclysm-firefly
    environment:
      APP_KEY: ${FIREFLY_APP_KEY:-SomeRandomStringOf32CharsExactly}
      APP_ENV: ${FIREFLY_APP_ENV:-production}
      SITE_OWNER: ${FIREFLY_SITE_OWNER:-ops@cataclysmstudios.com}
      DB_CONNECTION: ${FIREFLY_DB_CONNECTION:-sqlite}
      DB_DATABASE: ${FIREFLY_DB_DATABASE:-/var/www/html/storage/database/database.sqlite}
      TRUSTED_PROXIES: ${FIREFLY_TRUSTED_PROXIES:-**}
      TZ: ${FIREFLY_TZ:-America/New_York}
    ports:
      - "${FIREFLY_PORT:-8080}:8080"
    volumes:
      - firefly-storage:/var/www/html/storage

  open-notebook-surrealdb-ext:
    image: ${OPEN_NOTEBOOK_SURREAL_IMAGE:-surrealdb/surrealdb:v2}
    container_name: cataclysm-open-notebook-surrealdb
    command: start --log info --user ${OPEN_NOTEBOOK_SURREAL_USER:-root} --pass ${OPEN_NOTEBOOK_SURREAL_PASS:-root} rocksdb:/mydata/mydatabase.db
    restart: unless-stopped
    user: "0:0"
    networks:
      cataclysm:
        aliases:
          - cataclysm-open-notebook-surrealdb
    volumes:
      - ./data/open-notebook/surreal_data:/mydata

  open-notebook-ext:
    image: ${OPEN_NOTEBOOK_IMAGE:-ghcr.io/lfnovo/open-notebook:v1-latest}
    # Default to the forked Next.js v1 build; override OPEN_NOTEBOOK_IMAGE to use a different tag.
    container_name: cataclysm-open-notebook
    restart: unless-stopped
    env_file: [env.shared.generated, env.shared, .env.generated, .env.local]
    depends_on:
      - open-notebook-surrealdb-ext
    networks:
      cataclysm:
        aliases:
          - cataclysm-open-notebook
      pmoves:
        aliases:
          - cataclysm-open-notebook
    environment:
      SURREAL_URL: ${OPEN_NOTEBOOK_SURREAL_URL:-ws://cataclysm-open-notebook-surrealdb:8000/rpc}
      SURREAL_ADDRESS: ${OPEN_NOTEBOOK_SURREAL_ADDRESS:-cataclysm-open-notebook-surrealdb}
      SURREAL_PORT: ${OPEN_NOTEBOOK_SURREAL_PORT:-8000}
      SURREAL_USER: ${OPEN_NOTEBOOK_SURREAL_USER:-root}
      SURREAL_PASS: ${OPEN_NOTEBOOK_SURREAL_PASS:-root}
      SURREAL_NAMESPACE: ${OPEN_NOTEBOOK_SURREAL_NAMESPACE:-open-notebook}
      SURREAL_DATABASE: ${OPEN_NOTEBOOK_SURREAL_DATABASE:-open-notebook}
      OPEN_NOTEBOOK_API_TOKEN: ${OPEN_NOTEBOOK_API_TOKEN:-}
      OPEN_NOTEBOOK_PASSWORD: ${OPEN_NOTEBOOK_PASSWORD:-}
      OPEN_NOTEBOOK_API_URL: ${OPEN_NOTEBOOK_API_URL:-http://localhost:5055}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      VOYAGE_API_KEY: ${VOYAGE_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT:-}
      AZURE_OPENAI_DEPLOYMENT_NAME: ${AZURE_OPENAI_DEPLOYMENT_NAME:-}
      AZURE_OPENAI_API_VERSION: ${AZURE_OPENAI_API_VERSION:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      OLLAMA_API_BASE: ${OLLAMA_API_BASE:-}
      OPENAI_COMPATIBLE_BASE_URL: ${OPENAI_COMPATIBLE_BASE_URL:-}
      OPENAI_COMPATIBLE_BASE_URL_LLM: ${OPENAI_COMPATIBLE_BASE_URL_LLM:-}
      OPENAI_COMPATIBLE_BASE_URL_EMBEDDING: ${OPENAI_COMPATIBLE_BASE_URL_EMBEDDING:-}
      OPENAI_COMPATIBLE_BASE_URL_STT: ${OPENAI_COMPATIBLE_BASE_URL_STT:-}
      OPENAI_COMPATIBLE_BASE_URL_TTS: ${OPENAI_COMPATIBLE_BASE_URL_TTS:-}
      VERTEX_PROJECT: ${VERTEX_PROJECT:-}
      VERTEX_LOCATION: ${VERTEX_LOCATION:-}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-}
    ports:
      - "${OPEN_NOTEBOOK_UI_PORT:-8503}:8502"    # UI
      - "${OPEN_NOTEBOOK_API_PORT:-5055}:5055"  # API
    volumes:
      - ./data/open-notebook/notebook_data:/app/data

  jellyfin-ext:
    image: ${JELLYFIN_IMAGE:-ghcr.io/cataclysm-studios-inc/pmoves-jellyfin:pmoves-latest}
    container_name: cataclysm-jellyfin
    restart: unless-stopped
    env_file: [env.shared.generated, env.shared, .env.generated, .env.local]
    networks:
      cataclysm:
        aliases:
          - cataclysm-jellyfin
    environment:
      JELLYFIN_PublishedServerUrl: ${JELLYFIN_PUBLISHED_URL:-http://localhost:8096}
      JELLYFIN_MEDIA_ROOT: ${JELLYFIN_MEDIA_ROOT:-/media}
    ports:
      - "8096:8096"
    volumes:
      - ./data/jellyfin/config:/config
      - ./data/jellyfin/cache:/cache
      - ./data/jellyfin/transcode:/transcodes
      - ./data/jellyfin/media:/media

networks:
  cataclysm:
    external: true
    name: cataclysm-net
  pmoves:
    external: true
    name: pmoves-net

volumes:
  firefly-storage:
  wger-static:
  wger-media:
