# AgentGym-RL Integration Services
# Provides geometry-aware reinforcement learning for LLM agents
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.agentgym.yml --profile agentgym up -d
#
# Services:
#   - agentgym-rl-coordinator: Training job orchestrator
#   - agentgym-env-pmoves: PMOVES-HiRAG custom environment
#
# Ports:
#   - 8114: AgentGym-RL coordinator API
#   - 36000: PMOVES-HiRAG environment server
#
# Integration:
#   - EvoSwarm controller triggers training on fitness plateau
#   - Hi-RAG v2 provides knowledge retrieval for environment
#   - NATS carries training events (agentgym.train.*)
#   - Supabase stores trajectories and checkpoints
#   - MinIO stores model files

services:
  agentgym-rl-coordinator:
    build:
      context: ./services/agentgym-rl-coordinator
      dockerfile: Dockerfile
      args:
        - PYTHON_VERSION=3.10
    image: ghcr.io/powerfulmoves/agentgym-rl-coordinator:latest
    container_name: agentgym-rl-coordinator
    restart: unless-stopped
    env_file:
      - env.shared.generated
      - env.shared
      - .env.generated
      - .env.local
    environment:
      # Service config
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PORT=8114

      # AgentGym-RL config
      - AGENTGYM_BASE_MODEL=${AGENTGYM_BASE_MODEL:-Qwen2.5-7B-Instruct}
      - AGENTGYM_MODEL_PATH=/models
      - AGENTGYM_ENABLE=${AGENTGYM_ENABLE:-true}

      # Training defaults
      - AGENTGYM_DEFAULT_ALGORITHM=${AGENTGYM_DEFAULT_ALGORITHM:-ppo}
      - AGENTGYM_DEFAULT_HORIZON=${AGENTGYM_DEFAULT_HORIZON:-10}
      - AGENTGYM_DEFAULT_EPOCHS=${AGENTGYM_DEFAULT_EPOCHS:-25}
      - AGENTGYM_DEFAULT_BATCH_SIZE=${AGENTGYM_DEFAULT_BATCH_SIZE:-32}
      - AGENTGYM_DEFAULT_LR=${AGENTGYM_DEFAULT_LR:-1e-6}
      - AGENTGYM_DEFAULT_KL_COEF=${AGENTGYM_DEFAULT_KL_COEF:-0.001}

      # Reward weights
      - AGENTGYM_TASK_SUCCESS_WEIGHT=${AGENTGYM_TASK_SUCCESS_WEIGHT:-0.4}
      - AGENTGYM_RETRIEVAL_QUALITY_WEIGHT=${AGENTGYM_RETRIEVAL_QUALITY_WEIGHT:-0.3}
      - AGENTGYM_CGP_FITNESS_WEIGHT=${AGENTGYM_CGP_FITNESS_WEIGHT:-0.2}
      - AGENTGYM_EFFICIENCY_WEIGHT=${AGENTGYM_EFFICIENCY_WEIGHT:-0.1}

      # Environment config
      - AGENTGYM_ENV_MAX_TURNS=${AGENTGYM_ENV_MAX_TURNS:-15}
      - AGENTGYM_ENV_TIMEOUT=${AGENTGYM_ENV_TIMEOUT:-600}
      - AGENTGYM_ENV_NAMESPACE=${AGENTGYM_ENV_NAMESPACE:-pmoves.consciousness}
      - AGENTGYM_ENV_URL=http://agentgym-env-pmoves:36000

      # Integration endpoints
      - HIRAG_URL=${HIRAG_URL:-http://hi-rag-gateway-v2:8086}
      - SUPABASE_REST_URL=${SUPA_REST_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - NATS_URL=${NATS_URL:-nats://nats:4222}
      - TENSORZERO_BASE_URL=${TENSORZERO_BASE_URL}

      # Monitoring
      - AGENTGYM_WANDB_PROJECT=${AGENTGYM_WANDB_PROJECT:-pmoves-agentgym-rl}
      - AGENTGYM_WANDB_ENTITY=${AGENTGYM_WANDB_ENTITY:-pmoves-ai}
      - AGENTGYM_LOG_TRAJECTORIES=${AGENTGYM_LOG_TRAJECTORIES:-true}
      - AGENTGYM_SAVE_FREQ=${AGENTGYM_SAVE_FREQ:-5}

      # GPU config (if training on coordinator node)
      - AGENTGYM_GPU_MEMORY_UTILIZATION=${AGENTGYM_GPU_MEMORY_UTILIZATION:-0.7}
      - AGENTGYM_TENSOR_PARALLEL_SIZE=${AGENTGYM_TENSOR_PARALLEL_SIZE:-1}
      - USE_CUDA=${USE_CUDA:-true}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}

    ports:
      - "8114:8114"

    volumes:
      # AgentGym-RL framework (read-only)
      - ./vendor/agentgym-rl:/agentgym-rl:ro

      # Model storage (shared with other services)
      - agentgym-models:/models

      # Training logs
      - agentgym-logs:/logs

      # Coordinator service code (for live development)
      - ./services/agentgym-rl-coordinator:/app

    depends_on:
      - nats
      - hi-rag-gateway-v2
      - evo-controller
      - agentgym-env-pmoves
      - postgres

    profiles:
      - agents
      - agentgym

    networks:
      - app_tier
      - api_tier
      - data_tier
      - monitoring_tier

    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8114/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      com.pmoves.service: "agentgym-rl-coordinator"
      com.pmoves.tier: "agents"
      prometheus.io/scrape: "true"
      prometheus.io/port: "8114"
      prometheus.io/path: "/metrics"

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

  agentgym-env-pmoves:
    build:
      context: ./vendor/agentgym-rl
      dockerfile: environments/pmoves_hirag/Dockerfile
      args:
        - PYTHON_VERSION=3.10
    image: ghcr.io/powerfulmoves/agentgym-env-pmoves:latest
    container_name: agentgym-env-pmoves
    restart: unless-stopped
    env_file:
      - env.shared.generated
      - env.shared
      - .env.generated
      - .env.local
    environment:
      # Environment server config
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT_PORT=36000
      - ENVIRONMENT_NAME=pmoves-hirag

      # Hi-RAG integration
      - HIRAG_URL=${HIRAG_URL:-http://hi-rag-gateway-v2:8086}
      - HIRAG_GPU_URL=${HIRAG_GPU_URL:-http://hi-rag-gateway-v2-gpu:8086}
      - HIRAG_NAMESPACE=${AGENTGYM_ENV_NAMESPACE:-pmoves.consciousness}

      # Task generation
      - TASK_GENERATOR_MODE=constellation  # constellation|random|curriculum
      - TASK_DIFFICULTY_DISTRIBUTION=medium:0.5,easy:0.3,hard:0.2
      - MAX_TURNS_PER_EPISODE=${AGENTGYM_ENV_MAX_TURNS:-15}
      - EPISODE_TIMEOUT=${AGENTGYM_ENV_TIMEOUT:-600}

      # Supabase (for CGP fetching)
      - SUPABASE_REST_URL=${SUPA_REST_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}

      # Reward config (overridden by coordinator)
      - REWARD_TASK_SUCCESS_WEIGHT=${AGENTGYM_TASK_SUCCESS_WEIGHT:-0.4}
      - REWARD_RETRIEVAL_QUALITY_WEIGHT=${AGENTGYM_RETRIEVAL_QUALITY_WEIGHT:-0.3}
      - REWARD_CGP_FITNESS_WEIGHT=${AGENTGYM_CGP_FITNESS_WEIGHT:-0.2}
      - REWARD_EFFICIENCY_WEIGHT=${AGENTGYM_EFFICIENCY_WEIGHT:-0.1}

    ports:
      - "36000:36000"

    volumes:
      # Environment code (for live development)
      - ./vendor/agentgym-rl/environments/pmoves_hirag:/app

      # Task cache
      - agentgym-task-cache:/cache

    depends_on:
      - hi-rag-gateway-v2
      - postgres

    profiles:
      - agents
      - agentgym

    networks:
      - app_tier
      - data_tier

    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:36000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    labels:
      com.pmoves.service: "agentgym-env-pmoves"
      com.pmoves.tier: "agents"

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

volumes:
  agentgym-models:
    name: agentgym-models
    driver: local
    labels:
      com.pmoves.volume: "agentgym-models"
      com.pmoves.description: "AgentGym-RL model checkpoints"

  agentgym-logs:
    name: agentgym-logs
    driver: local
    labels:
      com.pmoves.volume: "agentgym-logs"
      com.pmoves.description: "AgentGym-RL training logs"

  agentgym-task-cache:
    name: agentgym-task-cache
    driver: local
    labels:
      com.pmoves.volume: "agentgym-task-cache"
      com.pmoves.description: "Cached constellation tasks for PMOVES-HiRAG environment"

networks:
  app_tier:
    external: true
  api_tier:
    external: true
  data_tier:
    external: true
  monitoring_tier:
    external: true
