import * as w3 from "/src/js/web3.js";
import {createStore} from "/src/lib/AlpineStore.js";
import * as a0t from "/src/js/A0T.js";

// Initialize the store
const store = {
  currentPrice: 0,
  currentPriceText: "...",
  initialPrice: 0,
  initialPriceText: "...",
  totalSupply: 0,
  totalSupplyText: "...",
  maxSupply: 0,
  maxSupplyText: "...",
  marketCap: 0,
  marketCapText: "...",
  priceChange: 0,
  priceChangeText: "...",
  basePrice: 0,
  basePriceText: "...",
  priceGrowth: 0,
  priceGrowthText: `...`,
  tokensRemaining: 0,
  tokensRemainingText: "...",
  burningPool: a0t.INITIAL_BURNING_POOL,
  burningPoolText: a0t.formatNumber(a0t.INITIAL_BURNING_POOL, 0),
  contractAddress: w3.config.tokenContractAddress,
  creatorAddress: w3.config.creatorAddress,
  signaturesContractAddress: w3.config.signaturesContractAddress,
  chainName: w3.config.chainName,
  chainId: w3.config.chainId,
  tokenSymbol: w3.config.tokenSymbol,
  tokenName: w3.config.tokenName,
  launchTime: w3.config.launchTime,
  launchTimeText: "",
  launched: false,
  untilLaunch: "",
  priceIncreaseExample: {
    purchaseEth: "",
    oldPrice: "",
    newPrice: "",
    effectivePrice: "",
    tokens: "",
    multiplier: "",
    percentIncrease: "",
  },
  simulationExample: [],

  async init() {
    await this.updateOnce();
    await this.updateAll();
    await this.updateLaunch();
    // Update every X seconds
    setInterval(() => this.updateAll(), 10000);
    setInterval(() => this.updateLaunch(), 1000);
  },

  async updateLaunch() {
    const now = Math.floor(Date.now() / 1000);
    this.launched = now > this.launchTime;
    if (this.launched) {
      this.untilLaunch = "Token is live!";
      return;
    }

    const diff = this.launchTime - now;
    const d = Math.floor(diff / 86400);
    const h = Math.floor((diff % 86400) / 3600);
    const m = Math.floor((diff % 3600) / 60);
    const s = diff % 60;

    const p = [];
    if (d > 0) p.push(`${d}d`);
    if (h > 0) p.push(`${h}h`);
    if (m > 0) p.push(`${m}m`);
    p.push(`${s}s`);

    this.untilLaunch = `Launching in ${p.join(", ")}`;
  },

  async updateOnce() {
    try {
      const basePrice = a0t.BASE_PRICE;
      this.basePrice = a0t.convertNumber(basePrice, 8);
      this.basePriceText = a0t.formatNumber(basePrice, 6);

      const initialPrice = a0t.INITIAL_PRICE;
      this.initialPrice = a0t.convertNumber(initialPrice, 8);
      this.initialPriceText = a0t.formatNumber(initialPrice, 6);

      const maxSupply = a0t.MAX_SUPPLY;
      this.maxSupply = a0t.convertNumber(maxSupply, 8);
      this.maxSupplyText = a0t.formatNumber(maxSupply, 0);

      const priceGrowth = a0t.PRICE_INCREASE_RATE;
      this.priceGrowth = a0t.convertNumber(priceGrowth, 8);
      this.priceGrowthText = `${a0t.formatNumberHtml(
        this.priceGrowth * 100,
        2
      )}%`;
    } catch (error) {
      console.error("Error updating store:", error);
    }

    //example for distribution modal
    const purchaseEth = a0t.toBigInt(100);
    const oldPrice = a0t.INITIAL_PRICE;
    const [newPrice, effectivePrice, tokens] = a0t.calculatePurchase(
      oldPrice,
      purchaseEth
    );
    this.priceIncreaseExample.purchaseEth = a0t.formatNumber(purchaseEth, 0);
    this.priceIncreaseExample.oldPrice = a0t.formatNumber(oldPrice, 6);
    this.priceIncreaseExample.newPrice = a0t.formatNumber(newPrice, 6);
    this.priceIncreaseExample.effectivePrice = a0t.formatNumber(
      effectivePrice,
      6
    );
    this.priceIncreaseExample.tokens = a0t.formatNumber(tokens, 8);
    this.priceIncreaseExample.multiplier = a0t.formatNumber(
      a0t.convertNumber(purchaseEth, 8) *
        a0t.convertNumber(a0t.PRICE_INCREASE_RATE, 8),
      2
    );
    this.priceIncreaseExample.percentIncrease =
      a0t.formatNumberHtml(
        (a0t.convertNumber(newPrice - oldPrice, 8) * 100) /
          a0t.convertNumber(oldPrice, 8),
        2
      ) + "%";

    function simulationExample(ethAmount) {
      const [newPrice, effectivePrice, tokens] = a0t.calculatePurchase(
        a0t.INITIAL_PRICE,
        ethAmount
      );
      const [, , burn] = a0t.calculatePurchase(newPrice, ethAmount);
      return {
        eth: a0t.formatNumber(ethAmount, 0),
        newPrice: a0t.formatNumber(newPrice, 6),
        effectivePrice: a0t.formatNumber(effectivePrice, 6),
        tokens: a0t.formatNumber(tokens, 0),
        burn: a0t.formatNumber(burn, 0),
      };
    }

    const max = a0t.calculateEthRequired(a0t.INITIAL_PRICE, a0t.MAX_SUPPLY);
    const simex = [];
    simex.push(simulationExample(1));
    simex.push(simulationExample(10));
    simex.push(simulationExample(100));
    simex.push(simulationExample(250));
    simex.push(simulationExample(500));
    simex.push(simulationExample(750));
    simex.push(simulationExample(max));
    this.simulationExample = simex;

    this.formatLaunchTime();
  },

  formatLaunchTime() {
    const date = new Date(this.launchTime * 1000);
    const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const months = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];

    const day = days[date.getUTCDay()];
    const month = months[date.getUTCMonth()];
    const dayNum = date.getUTCDate();
    const year = date.getUTCFullYear();
    const hour = String(date.getUTCHours()).padStart(2, '0');
    const minutes = String(date.getUTCMinutes()).padStart(2, '0');

    const suffix =
      dayNum === 1 ? "st" : dayNum === 2 ? "nd" : dayNum === 3 ? "rd" : "th";
    this.launchTimeText = `${day} ${month} ${dayNum}${suffix} ${year} ${hour}:${minutes} UTC`;
  },

  async updateAll() {
    try {
      const price = await w3.getCurrentPrice();
      this.currentPrice = a0t.convertNumber(price, 8);
      this.currentPriceText = a0t.formatNumber(price, 6);

      const supply = await w3.getTotalSupply();
      this.totalSupply = a0t.convertNumber(supply, 8);
      this.totalSupplyText = a0t.formatNumberHtml(supply, 0);

      // Calculate market cap
      const cap = (BigInt(price) * BigInt(supply)) / 10n ** 18n;
      this.marketCap = a0t.convertNumber(cap, 8);
      this.marketCapText = a0t.formatNumberHtml(cap, 2);

      //calculate price change
      this.priceChange =
        a0t.convertNumber(price, 8) / a0t.convertNumber(a0t.INITIAL_PRICE, 8); // * 100 -100;
      this.priceChangeText =
        "+" + a0t.formatNumberHtml(this.priceChange * 100 - 100, 2) + "%";
    } catch (error) {
      console.error("Error updating token metrics:", error);
    }

    let remaining = w3.fromBigInt(a0t.MAX_SUPPLY) - this.totalSupply;
    this.tokensRemaining = remaining;
    const decimals = remaining < 1000 ? 4 : 0;
    remaining = remaining < 1000 ? Math.floor(remaining) : remaining;
    this.tokensRemainingText = a0t.formatNumberHtml(remaining, decimals);
  },
};

export default createStore("token", store);
