# ============================================
# PMOVES.AI YouTube RAG System Testing Suite
# Complete validation and testing for all components
# ============================================

param(
    [Parameter(Position=0)]
    [ValidateSet('all', 'quick', 'api', 'search', 'processing', 'monitor', 'extension', 'performance')]
    [string]$TestType = 'quick',
    
    [switch]$Verbose,
    [switch]$SaveReport
)

$ErrorActionPreference = "Continue"

# Configuration
$Global:TestConfig = @{
    ApiUrl = "http://localhost:8000"
    QdrantUrl = "http://localhost:6333"
    RedisUrl = "localhost:6379"
    FrontendUrl = "http://localhost:3001"
    TestVideoUrl = "https://www.youtube.com/watch?v=dPL2vRDunMw"
    TestChannelUrl = "https://www.youtube.com/@Fireship"
    ApiKey = "test-api-key"
    ReportPath = "C:\Users\russe\Documents\GitHub\PMOVES.AI\youtube-rag\test-reports"
}

# Test Results Storage
$Global:TestResults = @{
    Passed = 0
    Failed = 0
    Skipped = 0
    Warnings = 0
    StartTime = Get-Date
    Tests = @()
}

# ============================================
# TEST FRAMEWORK
# ============================================

function Test-Assert {
    param(
        [string]$Name,
        [scriptblock]$Test,
        [string]$Category = "General"
    )
    
    $result = @{
        Name = $Name
        Category = $Category
        Status = "Unknown"
        Duration = 0
        Error = $null
    }
    
    Write-Host "  Testing: $Name... " -NoNewline
    
    $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
    
    try {
        $testResult = & $Test
        
        if ($testResult) {
            $result.Status = "Passed"
            $Global:TestResults.Passed++
            Write-Host "âœ… PASS" -ForegroundColor Green
        } else {
            $result.Status = "Failed"
            $Global:TestResults.Failed++
            Write-Host "âŒ FAIL" -ForegroundColor Red
        }
    } catch {
        $result.Status = "Error"
        $result.Error = $_.Exception.Message
        $Global:TestResults.Failed++
        Write-Host "âŒ ERROR: $_" -ForegroundColor Red
        
        if ($Verbose) {
            Write-Host "    Stack Trace: $($_.ScriptStackTrace)" -ForegroundColor Gray
        }
    } finally {
        $stopwatch.Stop()
        $result.Duration = $stopwatch.ElapsedMilliseconds
    }
    
    $Global:TestResults.Tests += $result
    
    if ($Verbose -and $result.Status -eq "Passed") {
        Write-Host "    Duration: $($result.Duration)ms" -ForegroundColor Gray
    }
}

# ============================================
# INFRASTRUCTURE TESTS
# ============================================

function Test-Infrastructure {
    Write-Host "`nğŸ—ï¸  INFRASTRUCTURE TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    Test-Assert "Docker is running" {
        $dockerInfo = docker info 2>$null
        return $LASTEXITCODE -eq 0
    } -Category "Infrastructure"
    
    Test-Assert "Redis connectivity" {
        $connection = Test-NetConnection -ComputerName localhost -Port 6379 -InformationLevel Quiet
        return $connection
    } -Category "Infrastructure"
    
    Test-Assert "Qdrant connectivity" {
        try {
            $response = Invoke-RestMethod -Uri "$($Global:TestConfig.QdrantUrl)/collections" -Method Get
            return $true
        } catch {
            return $false
        }
    } -Category "Infrastructure"
    
    Test-Assert "PostgreSQL connectivity" {
        # Test Supabase connection
        $env:PGPASSWORD = "your-password"
        $result = psql -h localhost -U postgres -c "SELECT 1" 2>$null
        return $LASTEXITCODE -eq 0
    } -Category "Infrastructure"
    
    Test-Assert "API health check" {
        try {
            $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/health" -Method Get
            return $response.status -eq "healthy"
        } catch {
            return $false
        }
    } -Category "Infrastructure"
}

# ============================================
# API TESTS
# ============================================

function Test-API {
    Write-Host "`nğŸš€ API ENDPOINT TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    # Authentication
    Test-Assert "API requires authentication" {
        try {
            $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search" `
                -Method Post `
                -Body (@{query = "test"} | ConvertTo-Json) `
                -ContentType "application/json"
            return $false  # Should fail without API key
        } catch {
            return $_.Exception.Response.StatusCode -eq 401
        }
    } -Category "API/Auth"
    
    # Search Endpoint
    Test-Assert "Search endpoint with API key" {
        try {
            $headers = @{ "X-API-Key" = $Global:TestConfig.ApiKey }
            $body = @{
                query = "knowledge graphs"
                search_type = "coca"
                limit = 5
            } | ConvertTo-Json
            
            $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search" `
                -Method Post `
                -Headers $headers `
                -Body $body `
                -ContentType "application/json"
            
            return $response.total_results -ge 0
        } catch {
            return $false
        }
    } -Category "API/Search"
    
    # Process Endpoint
    Test-Assert "Process videos endpoint" {
        try {
            $headers = @{ "X-API-Key" = $Global:TestConfig.ApiKey }
            $body = @{
                urls = @($Global:TestConfig.TestVideoUrl)
                priority = "normal"
            } | ConvertTo-Json
            
            $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/process" `
                -Method Post `
                -Headers $headers `
                -Body $body `
                -ContentType "application/json"
            
            return $response.job_id -ne $null
        } catch {
            return $false
        }
    } -Category "API/Process"
    
    # Chat Endpoint
    Test-Assert "Chat endpoint" {
        try {
            $headers = @{ "X-API-Key" = $Global:TestConfig.ApiKey }
            $body = @{
                message = "What are the main topics in the videos?"
                max_tokens = 500
            } | ConvertTo-Json
            
            $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/chat" `
                -Method Post `
                -Headers $headers `
                -Body $body `
                -ContentType "application/json"
            
            return $response.conversation_id -ne $null
        } catch {
            return $false
        }
    } -Category "API/Chat"
    
    # Rate Limiting
    Test-Assert "Rate limiting works" {
        $headers = @{ "X-API-Key" = "test-rate-limit" }
        $successCount = 0
        
        for ($i = 0; $i -lt 150; $i++) {
            try {
                $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search/suggest?q=test" `
                    -Method Get `
                    -Headers $headers
                $successCount++
            } catch {
                if ($_.Exception.Response.StatusCode -eq 429) {
                    return $successCount -gt 0 -and $successCount -lt 150
                }
            }
        }
        
        return $false
    } -Category "API/RateLimit"
}

# ============================================
# SEARCH TESTS
# ============================================

function Test-Search {
    Write-Host "`nğŸ” SEARCH FUNCTIONALITY TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    $headers = @{ "X-API-Key" = $Global:TestConfig.ApiKey }
    
    # Test each search type
    @("coca", "hybrid", "vector", "keyword") | ForEach-Object {
        $searchType = $_
        
        Test-Assert "$searchType search" {
            $body = @{
                query = "machine learning"
                search_type = $searchType
                limit = 5
            } | ConvertTo-Json
            
            $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search" `
                -Method Post `
                -Headers $headers `
                -Body $body `
                -ContentType "application/json"
            
            return $response.search_type -eq $searchType
        } -Category "Search/$searchType"
    }
    
    # Test context inclusion
    Test-Assert "Search with context" {
        $body = @{
            query = "test query"
            include_context = $true
            context_window = 2
        } | ConvertTo-Json
        
        $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search" `
            -Method Post `
            -Headers $headers `
            -Body $body `
            -ContentType "application/json"
        
        return $true
    } -Category "Search/Context"
    
    # Test suggestions
    Test-Assert "Search suggestions" {
        $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search/suggest?q=mach" `
            -Method Get `
            -Headers $headers
        
        return $response -is [array]
    } -Category "Search/Suggestions"
}

# ============================================
# PROCESSING TESTS
# ============================================

function Test-Processing {
    Write-Host "`nâš™ï¸  PROCESSING PIPELINE TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    $headers = @{ "X-API-Key" = $Global:TestConfig.ApiKey }
    
    # Submit processing job
    Test-Assert "Submit processing job" {
        $body = @{
            urls = @($Global:TestConfig.TestVideoUrl)
            priority = "normal"
            extract_chapters = $true
            generate_summary = $true
        } | ConvertTo-Json
        
        $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/process" `
            -Method Post `
            -Headers $headers `
            -Body $body `
            -ContentType "application/json"
        
        $Global:TestJobId = $response.job_id
        return $response.status -eq "queued"
    } -Category "Processing/Submit"
    
    # Check job status
    Test-Assert "Check job status" {
        if (!$Global:TestJobId) { return $false }
        
        $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/process/status/$($Global:TestJobId)" `
            -Method Get `
            -Headers $headers
        
        return $response.job_id -eq $Global:TestJobId
    } -Category "Processing/Status"
    
    # Test batch processing
    Test-Assert "Batch processing" {
        $body = @{
            urls = @(
                "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                "https://www.youtube.com/watch?v=9bZkp7q19f0"
            )
            priority = "low"
        } | ConvertTo-Json
        
        $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/process" `
            -Method Post `
            -Headers $headers `
            -Body $body `
            -ContentType "application/json"
        
        return $response.urls_queued -eq 2
    } -Category "Processing/Batch"
}

# ============================================
# CHANNEL MONITOR TESTS
# ============================================

function Test-ChannelMonitor {
    Write-Host "`nğŸ“¡ CHANNEL MONITOR TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    # Get monitoring stats
    Test-Assert "Get monitoring statistics" {
        try {
            $response = Invoke-RestMethod -Uri "http://localhost:8002/api/monitor/stats" -Method Get
            return $response.statistics -ne $null
        } catch {
            return $false
        }
    } -Category "Monitor/Stats"
    
    # Add channel
    Test-Assert "Add channel to monitor" {
        try {
            $body = @{
                url = $Global:TestConfig.TestChannelUrl
                auto_process = $true
                check_interval = 120
            } | ConvertTo-Json
            
            $response = Invoke-RestMethod -Uri "http://localhost:8002/api/monitor/channel" `
                -Method Post `
                -Body $body `
                -ContentType "application/json"
            
            return $response.status -in @("added", "exists")
        } catch {
            return $false
        }
    } -Category "Monitor/Add"
    
    # Get channels
    Test-Assert "List monitored channels" {
        try {
            $response = Invoke-RestMethod -Uri "http://localhost:8002/api/monitor/channels" -Method Get
            return $response -is [array]
        } catch {
            return $false
        }
    } -Category "Monitor/List"
}

# ============================================
# CHROME EXTENSION TESTS
# ============================================

function Test-ChromeExtension {
    Write-Host "`nğŸŒ CHROME EXTENSION TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    $extensionPath = "C:\Users\russe\Documents\GitHub\PMOVES.AI\youtube-rag\chrome-extension"
    
    # Check extension files
    Test-Assert "Extension manifest exists" {
        Test-Path "$extensionPath\manifest.json"
    } -Category "Extension/Files"
    
    Test-Assert "Background script exists" {
        Test-Path "$extensionPath\background.js"
    } -Category "Extension/Files"
    
    Test-Assert "Content script exists" {
        Test-Path "$extensionPath\content.js"
    } -Category "Extension/Files"
    
    Test-Assert "Popup HTML exists" {
        Test-Path "$extensionPath\popup\popup.html"
    } -Category "Extension/Files"
    
    # Validate manifest
    Test-Assert "Manifest is valid JSON" {
        try {
            $manifest = Get-Content "$extensionPath\manifest.json" | ConvertFrom-Json
            return $manifest.manifest_version -eq 3
        } catch {
            return $false
        }
    } -Category "Extension/Manifest"
}

# ============================================
# PERFORMANCE TESTS
# ============================================

function Test-Performance {
    Write-Host "`nâš¡ PERFORMANCE TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    $headers = @{ "X-API-Key" = $Global:TestConfig.ApiKey }
    
    # Search latency
    Test-Assert "Search latency < 500ms" {
        $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
        
        $body = @{
            query = "test performance"
            search_type = "coca"
            limit = 10
        } | ConvertTo-Json
        
        $response = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search" `
            -Method Post `
            -Headers $headers `
            -Body $body `
            -ContentType "application/json"
        
        $stopwatch.Stop()
        
        if ($Verbose) {
            Write-Host "    Search took: $($stopwatch.ElapsedMilliseconds)ms" -ForegroundColor Gray
        }
        
        return $stopwatch.ElapsedMilliseconds -lt 500
    } -Category "Performance/Search"
    
    # Concurrent requests
    Test-Assert "Handle concurrent requests" {
        $jobs = @()
        
        1..10 | ForEach-Object {
            $jobs += Start-Job -ScriptBlock {
                param($url, $headers)
                
                try {
                    Invoke-RestMethod -Uri "$url/api/v1/search/suggest?q=test" `
                        -Method Get `
                        -Headers $headers
                    return $true
                } catch {
                    return $false
                }
            } -ArgumentList $Global:TestConfig.ApiUrl, $headers
        }
        
        $results = $jobs | Wait-Job | Receive-Job
        $jobs | Remove-Job
        
        $successCount = ($results | Where-Object { $_ -eq $true }).Count
        return $successCount -ge 8  # At least 80% success
    } -Category "Performance/Concurrent"
    
    # Memory usage
    Test-Assert "Qdrant memory usage reasonable" {
        try {
            $stats = docker stats pmoves-qdrant --no-stream --format "{{.MemUsage}}"
            $memoryMB = [int]($stats -replace '[^0-9.]', '')
            
            if ($Verbose) {
                Write-Host "    Qdrant memory: ${memoryMB}MB" -ForegroundColor Gray
            }
            
            return $memoryMB -lt 2048  # Less than 2GB
        } catch {
            return $true  # Skip if Docker not available
        }
    } -Category "Performance/Memory"
}

# ============================================
# INTEGRATION TESTS
# ============================================

function Test-Integration {
    Write-Host "`nğŸ”— END-TO-END INTEGRATION TESTS" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    
    $headers = @{ "X-API-Key" = $Global:TestConfig.ApiKey }
    
    # Complete workflow test
    Test-Assert "Complete processing workflow" {
        # 1. Submit video for processing
        $processBody = @{
            urls = @($Global:TestConfig.TestVideoUrl)
            priority = "high"
        } | ConvertTo-Json
        
        $processResponse = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/process" `
            -Method Post `
            -Headers $headers `
            -Body $processBody `
            -ContentType "application/json"
        
        $jobId = $processResponse.job_id
        
        # 2. Wait for processing (with timeout)
        $timeout = [DateTime]::Now.AddSeconds(30)
        $completed = $false
        
        while ([DateTime]::Now -lt $timeout) {
            $statusResponse = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/process/status/$jobId" `
                -Method Get `
                -Headers $headers
            
            if ($statusResponse.status -in @("completed", "failed")) {
                $completed = $statusResponse.status -eq "completed"
                break
            }
            
            Start-Sleep -Seconds 2
        }
        
        if (!$completed) {
            return $false
        }
        
        # 3. Search for content from the video
        $searchBody = @{
            query = "LangExtract"
            search_type = "coca"
        } | ConvertTo-Json
        
        $searchResponse = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search" `
            -Method Post `
            -Headers $headers `
            -Body $searchBody `
            -ContentType "application/json"
        
        return $searchResponse.total_results -gt 0
    } -Category "Integration/Workflow"
    
    # Chat with context
    Test-Assert "Chat with retrieved context" {
        # 1. Search for content
        $searchBody = @{
            query = "knowledge graphs"
            search_type = "coca"
            limit = 3
        } | ConvertTo-Json
        
        $searchResponse = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/search" `
            -Method Post `
            -Headers $headers `
            -Body $searchBody `
            -ContentType "application/json"
        
        # 2. Chat about the results
        $chatBody = @{
            message = "Based on the videos, what are knowledge graphs used for?"
            max_tokens = 200
        } | ConvertTo-Json
        
        $chatResponse = Invoke-RestMethod -Uri "$($Global:TestConfig.ApiUrl)/api/v1/chat" `
            -Method Post `
            -Headers $headers `
            -Body $chatBody `
            -ContentType "application/json"
        
        return $chatResponse.message.Length -gt 50 -and $chatResponse.sources.Count -gt 0
    } -Category "Integration/ChatRAG"
}

# ============================================
# TEST REPORT GENERATION
# ============================================

function Generate-TestReport {
    $duration = (Get-Date) - $Global:TestResults.StartTime
    $totalTests = $Global:TestResults.Passed + $Global:TestResults.Failed + $Global:TestResults.Skipped
    
    $report = @"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PMOVES.AI YOUTUBE RAG TEST REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Test Run: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
Duration: $($duration.TotalSeconds) seconds

SUMMARY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total Tests:    $totalTests
Passed:         $($Global:TestResults.Passed) ($(($Global:TestResults.Passed/$totalTests*100).ToString("F1"))%)
Failed:         $($Global:TestResults.Failed) ($(($Global:TestResults.Failed/$totalTests*100).ToString("F1"))%)
Skipped:        $($Global:TestResults.Skipped)
Warnings:       $($Global:TestResults.Warnings)

TEST RESULTS BY CATEGORY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"@
    
    # Group results by category
    $categories = $Global:TestResults.Tests | Group-Object -Property Category
    
    foreach ($category in $categories) {
        $passed = ($category.Group | Where-Object Status -eq "Passed").Count
        $failed = ($category.Group | Where-Object Status -eq "Failed").Count
        
        $report += "`n$($category.Name):"
        $report += "`n  Passed: $passed | Failed: $failed"
        
        if ($failed -gt 0) {
            $failedTests = $category.Group | Where-Object Status -eq "Failed"
            foreach ($test in $failedTests) {
                $report += "`n    âŒ $($test.Name)"
                if ($test.Error) {
                    $report += "`n       Error: $($test.Error)"
                }
            }
        }
    }
    
    # Performance metrics
    $report += @"

PERFORMANCE METRICS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"@
    
    $performanceTests = $Global:TestResults.Tests | Where-Object { $_.Category -like "Performance*" }
    foreach ($test in $performanceTests) {
        $report += "`n$($test.Name): $($test.Duration)ms"
    }
    
    # Save report if requested
    if ($SaveReport) {
        if (!(Test-Path $Global:TestConfig.ReportPath)) {
            New-Item -ItemType Directory -Path $Global:TestConfig.ReportPath -Force | Out-Null
        }
        
        $reportFile = Join-Path $Global:TestConfig.ReportPath "test-report-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"
        $report | Out-File $reportFile
        
        Write-Host "`nReport saved to: $reportFile" -ForegroundColor Green
    }
    
    return $report
}

# ============================================
# MAIN EXECUTION
# ============================================

Clear-Host
Write-Host @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          PMOVES.AI YOUTUBE RAG SYSTEM TESTING            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"@ -ForegroundColor Cyan

Write-Host "Starting test suite: $TestType" -ForegroundColor Yellow
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan

# Run tests based on type
switch ($TestType) {
    'all' {
        Test-Infrastructure
        Test-API
        Test-Search
        Test-Processing
        Test-ChannelMonitor
        Test-ChromeExtension
        Test-Performance
        Test-Integration
    }
    'quick' {
        Test-Infrastructure
        Test-API
        Test-Search
    }
    'api' {
        Test-API
    }
    'search' {
        Test-Search
    }
    'processing' {
        Test-Processing
    }
    'monitor' {
        Test-ChannelMonitor
    }
    'extension' {
        Test-ChromeExtension
    }
    'performance' {
        Test-Performance
    }
}

# Generate and display report
Write-Host "`n" -NoNewline
$report = Generate-TestReport
Write-Host $report

# Exit code based on results
if ($Global:TestResults.Failed -gt 0) {
    exit 1
} else {
    exit 0
}