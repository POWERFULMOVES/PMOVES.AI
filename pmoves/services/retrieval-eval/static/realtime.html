<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PMOVES Realtime (Supabase)</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 20px; }
      input { width: 420px; }
      pre { background: #f6f8fa; padding: 10px; overflow-x: auto; }
      .row { margin: 6px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <h3>PMOVES Realtime (Supabase)</h3>
    <div class="row">
      <label>Supabase URL <input id="url" value="http://localhost:54321"/></label>
    </div>
    <div class="row">
      <label>Anon Key <input id="anon" placeholder="paste anon key here"/></label>
    </div>
    <div class="row">
      <button onclick="connect()">Connect & Subscribe</button>
      <span id="status"></span>
    </div>
    <h4>Quick Actions</h4>
    <div class="row">
      <button onclick="insertBoard()">Insert Demo studio_board Row</button>
      <button onclick="insertError()">Insert Demo it_errors Row</button>
      <span id="act"></span>
    </div>

    <h4>Avatar Preview</h4>
    <div class="row">
      <label>Public Avatar URL <input id="avatarUrl" placeholder="http://localhost:54321/storage/v1/object/public/avatars/sample.png"/></label>
      <button onclick="showAvatar()">Show</button>
    </div>
    <div class="row"><img id="avatar" style="max-width:240px; border:1px solid #ddd;" alt="avatar preview"/></div>
    <div class="row">
      <label>Upload Avatar <input id="upload" type="file" accept="image/*"/></label>
      <button onclick="uploadAvatar()">Upload</button>
      <span id="upl"></span>
    </div>
    <div class="row">
      <button onclick="assignAvatar()">Assign Avatar to Latest studio_board</button>
      <span id="assn"></span>
    </div>

    <h4>Agents</h4>
    <div class="row">
      <label>Name <input id="agentName" placeholder="Agent Zero"/></label>
      <label>Role <input id="agentRole" placeholder="orchestrator"/></label>
      <button onclick="upsertAgent()">Upsert Agent</button>
      <button onclick="assignAgentAvatar()">Assign Avatar to Agent (by name)</button>
    </div>
    <div class="row"><button onclick="loadAgents()">Load Agents</button></div>
    <pre id="agents"></pre>
    <h4>Events</h4>
    <pre id="log"></pre>

    <script>
      let supabase, sub1, sub2
      function log(line){
        const el = document.getElementById('log')
        el.textContent += line + "\n"
        el.scrollTop = el.scrollHeight
      }
      async function connect(){
        const url = document.getElementById('url').value.trim()
        const anon = document.getElementById('anon').value.trim()
        document.getElementById('status').textContent = 'connecting...'
        supabase = window.supabase.createClient(url, anon, { realtime: { params: { eventsPerSecond: 2 }}})
        sub1 = supabase
          .channel('studio_board_changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'studio_board' }, payload => {
            log('[studio_board] ' + JSON.stringify(payload))
          })
          .subscribe((status) => log('[studio_board] status: ' + status))
        sub2 = supabase
          .channel('it_errors_changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'it_errors' }, payload => {
            log('[it_errors] ' + JSON.stringify(payload))
          })
          .subscribe((status) => log('[it_errors] status: ' + status))
        document.getElementById('status').textContent = 'connected'
      }

      async function insertBoard(){
        const r = await fetch('/demo/insert_board', {method:'POST'})
        document.getElementById('act').textContent = 'studio_board insert: ' + r.status
      }
      async function insertError(){
        const r = await fetch('/demo/insert_error', {method:'POST'})
        document.getElementById('act').textContent = 'it_errors insert: ' + r.status
      }
      function showAvatar(){
        const u = document.getElementById('avatarUrl').value.trim()
        document.getElementById('avatar').src = u
      }
      async function uploadAvatar(){
        const f = document.getElementById('upload').files[0]
        if(!f){ document.getElementById('upl').textContent = 'choose a file'; return }
        const fd = new FormData(); fd.append('file', f)
        const r = await fetch('/demo/upload_avatar', { method: 'POST', body: fd })
        const j = await r.json();
        document.getElementById('upl').textContent = 'upload: ' + (j.ok ? 'OK' : ('ERR ' + j.status))
        if(j.public_url){ document.getElementById('avatarUrl').value = j.public_url; showAvatar() }
      }
      async function assignAvatar(){
        const u = document.getElementById('avatarUrl').value.trim()
        if(!u){ document.getElementById('assn').textContent = 'no URL'; return }
        const r = await fetch('/demo/assign_avatar', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({avatar_url: u}) })
        document.getElementById('assn').textContent = 'assign: ' + r.status
      }

      // Agents UI
      async function upsertAgent(){
        const name = document.getElementById('agentName').value.trim()
        const role = document.getElementById('agentRole').value.trim()
        if(!name){ alert('enter name'); return }
        await fetch('/demo/agent_upsert', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({name, role}) })
        await loadAgents()
      }
      async function assignAgentAvatar(){
        const name = document.getElementById('agentName').value.trim()
        const u = document.getElementById('avatarUrl').value.trim()
        if(!name || !u){ alert('need name and avatar URL'); return }
        await fetch('/demo/agent_assign_avatar', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({name, avatar_url: u}) })
        await loadAgents()
      }
      async function loadAgents(){
        const r = await fetch('/demo/agents')
        const j = await r.json()
        document.getElementById('agents').textContent = JSON.stringify(j.items||[], null, 2)
      }
    </script>
  </body>
  </html>
